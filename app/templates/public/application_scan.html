{% extends "layout.html" %}

{% block title %}申請自然人憑證 - 掃描頁面{% endblock %}

{% block extra_css %}
<style>
    .qr-container {
        padding: 20px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
        max-width: 300px;
        margin: 0 auto;
    }
    
    .progress-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
    }
    
    .step {
        flex: 1;
        text-align: center;
        position: relative;
    }
    
    .step:not(:last-child):after {
        content: '';
        position: absolute;
        top: 15px;
        right: -50%;
        width: 100%;
        height: 2px;
        background-color: #dee2e6;
        z-index: 1;
    }
    
    .step.active .step-icon {
        background-color: #0d6efd;
        color: white;
    }
    
    .step.active:not(:last-child):after {
        background-color: #0d6efd;
    }
    
    .step-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #dee2e6;
        color: #6c757d;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto 10px;
        z-index: 2;
        position: relative;
    }
    
    .pulse {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(13, 110, 253, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0">申請自然人憑證</h2>
                </div>
                <div class="card-body">
                    <div class="progress-steps mb-4">
                        <div class="step active">
                            <div class="step-icon pulse">1</div>
                            <div class="step-label">掃描</div>
                        </div>
                        <div class="step">
                            <div class="step-icon">2</div>
                            <div class="step-label">資料填寫</div>
                        </div>
                        <div class="step">
                            <div class="step-icon">3</div>
                            <div class="step-label">審核</div>
                        </div>
                        <div class="step">
                            <div class="step-icon">4</div>
                            <div class="step-label">領取憑證</div>
                        </div>
                    </div>

                    <div class="alert alert-info mb-4">
                        <h5 class="alert-heading mb-1">申請ID</h5>
                        <p class="mb-0"><strong>{{ application.id }}</strong><br>請記錄此ID以便後續查詢申請狀態。</p>
                    </div>

                    <div class="text-center mb-4">
                        <h4 class="h5 mb-3">使用數位皮夾掃描QR碼</h4>
                        <p class="text-muted mb-4">請用您的數位皮夾 (wallet.io) 掃描以下QR碼啟動申請流程。</p>
                        
                        <div class="qr-container mb-4">
                            <img src="data:image/png;base64,{{ qr_code }}" alt="QR碼" class="img-fluid">
                        </div>
                        
                        <div class="alert alert-light border text-start small mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <div>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle me-2" viewBox="0 0 16 16">
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                                    </svg>
                                </div>
                                <div><strong>如何使用數位皮夾</strong></div>
                            </div>
                            <ol class="mb-0 ps-3">
                                <li>開啟您的數位皮夾應用 (wallet.io)</li>
                                <li>點擊「掃描」功能</li>
                                <li>對準上方QR碼掃描</li>
                                <li>確認您的DID並填寫個人資料</li>
                                <li>提交資料完成申請</li>
                            </ol>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="card border">
                            <div class="card-header bg-light">
                                <h5 class="h6 mb-0">沒有數位皮夾？</h5>
                            </div>
                            <div class="card-body">
                                <p class="small mb-3">您可以使用以下連結從您的手機開啟數位皮夾，或複製連結在其他裝置上開啟：</p>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control form-control-sm" value="{{ qr_content }}" readonly>
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="copyToClipboard()">複製</button>
                                </div>
                                <div class="text-center mt-3">
                                    <a href="{{ qr_content }}" target="_blank" class="btn btn-sm btn-outline-primary">開啟數位皮夾</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning mb-4">
                        <h5 class="alert-heading mb-1">等待資料提交</h5>
                        <p class="mb-0">掃描QR碼後，請在數位皮夾中填寫並提交您的個人資料。完成後，系統將自動更新申請狀態。</p>
                    </div>

                    <div class="d-grid gap-2">
                        <a href="{{ url_for('public.application_status', application_id=application.id) }}" class="btn btn-primary">檢查申請狀態</a>
                        <a href="{{ url_for('public.index') }}" class="btn btn-outline-secondary">返回首頁</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 複製到剪貼簿功能
function copyToClipboard() {
    const input = document.querySelector('input[readonly]');
    input.select();
    document.execCommand('copy');
    
    // 顯示複製成功提示
    const button = document.querySelector('button');
    const originalText = button.textContent;
    button.textContent = '已複製!';
    button.classList.add('btn-success');
    button.classList.remove('btn-outline-secondary');
    
    setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 2000);
}

// 定期檢查申請狀態
function checkApplicationStatus() {
    const applicationId = "{{ application.id }}";
    
    // 每10秒檢查一次申請狀態
    const statusInterval = setInterval(() => {
        fetch(`/api/v1/application/${applicationId}/status`)
            .then(response => response.json())
            .then(data => {
                // 如果收到DID和個人資料，重定向到狀態頁面
                if (data.status && data.status !== 'pending') {
                    clearInterval(statusInterval);
                    window.location.href = `/application/${applicationId}/status`;
                }
            })
            .catch(error => {
                console.error('檢查申請狀態錯誤:', error);
            });
    }, 10000);
}

// 頁面加載時啟動檢查
document.addEventListener('DOMContentLoaded', function() {
    // 只有在生產環境啟用自動檢查，開發環境可以手動檢查
    if (!window.location.hostname.includes('localhost')) {
        checkApplicationStatus();
    }
});
</script>
{% endblock %}